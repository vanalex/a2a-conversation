version: '3.8'

services:
  # Kafka broker
  kafka:
    image: apache/kafka:latest
    container_name: a2a-kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 2
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions.sh --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - a2a-network

  # A2A Conversation Application
  a2a-conversation:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: a2a-conversation-app
    depends_on:
      kafka:
        condition: service_healthy
    environment:
      # OpenAI Configuration (required - set via .env or override here)
      OPENAI_API_KEY: ${OPENAI_API_KEY}

      # LLM Configuration
      LLM_MODEL: ${LLM_MODEL:-gpt-4}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.8}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS:-500}

      # Kafka Configuration
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      KAFKA_ALICE_TOPIC: ${KAFKA_ALICE_TOPIC:-alice-messages}
      KAFKA_BOB_TOPIC: ${KAFKA_BOB_TOPIC:-bob-messages}
      KAFKA_CONSUMER_TIMEOUT_MS: ${KAFKA_CONSUMER_TIMEOUT_MS:-30000}

      # Application Configuration
      MAX_TURNS: ${MAX_TURNS:-12}
      STARTUP_DELAY_SECONDS: ${STARTUP_DELAY_SECONDS:-3}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FILE: ${LOG_FILE:-logs/a2a_conversation.log}
    volumes:
      # Mount logs directory to persist logs
      - ./logs:/app/logs
    networks:
      - a2a-network
    restart: unless-stopped

networks:
  a2a-network:
    driver: bridge
